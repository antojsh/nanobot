version: '3.8'

services:
  nanobot:
    build: .
    container_name: nanobot_ai
    restart: always
    # Usamos shell para poder crear el archivo de configuraciÃ³n antes de arrancar
    entrypoint: ["/bin/sh", "-c"]
    
    # EL CAMBIO CLAVE: Usamos 'nanobot gateway'
    command: 
      - |
        mkdir -p /root/.nanobot
        echo "{\"providers\":{\"openai\":{\"apiKey\":\"$DEEPSEEK_API_KEY\",\"baseURL\":\"https://api.deepseek.com\"}},\"telegram\":{\"token\":\"$TELEGRAM_BOT_TOKEN\",\"admins\":[\"$TELEGRAM_ADMIN_ID\"]},\"agents\":{\"defaults\":{\"model\":\"deepseek-chat\"}}}" > /root/.nanobot/config.json
        nanobot gateway
    
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_ID=${TELEGRAM_ADMIN_ID}
      # A veces Python necesita esto para mostrar los logs en tiempo real
      - PYTHONUNBUFFERED=1
    
    volumes:
      - nanobot_session_data:/root/.nanobot
    
    ports:
      - "18790:18790"

volumes:
  nanobot_session_data:
