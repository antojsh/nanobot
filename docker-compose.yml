version: '3.8'

services:
  nanobot:
    build: .
    container_name: nanobot_ai
    restart: always
    entrypoint: ["/bin/sh", "-c"]
    
    # CORRECCIÓN: Quitamos el bloque "telegram" del JSON porque Nanobot
    # lo leerá automáticamente de las variables de entorno de abajo.
    command: 
      - |
        mkdir -p /root/.nanobot
        echo "{\"providers\":{\"openai\":{\"apiKey\":\"$DEEPSEEK_API_KEY\",\"baseURL\":\"https://api.deepseek.com\"}},\"agents\":{\"defaults\":{\"model\":\"deepseek-chat\"}}}" > /root/.nanobot/config.json
        nanobot gateway
    
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      # Estas variables las tomará el gateway automáticamente
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_ID=${TELEGRAM_ADMIN_ID}
      - PYTHONUNBUFFERED=1
    
    volumes:
      - nanobot_session_data:/root/.nanobot
    
    ports:
      - "18790:18790"

volumes:
  nanobot_session_data:
