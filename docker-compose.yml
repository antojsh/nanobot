version: '3.8'

services:
  nanobot:
    build: .
    container_name: nanobot_ai
    restart: always
    # Sobrescribimos el Entrypoint para usar comandos de shell
    entrypoint: ["/bin/sh", "-c"]
    
    # CAMBIO IMPORTANTE: Cambiamos 'nanobot start' por 'nanobot run'
    command: 
      - |
        mkdir -p /root/.nanobot
        echo "{\"providers\":{\"openai\":{\"apiKey\":\"$DEEPSEEK_API_KEY\",\"baseURL\":\"https://api.deepseek.com\"}},\"telegram\":{\"token\":\"$TELEGRAM_BOT_TOKEN\",\"admins\":[\"$TELEGRAM_ADMIN_ID\"]},\"agents\":{\"defaults\":{\"model\":\"deepseek-chat\"}}}" > /root/.nanobot/config.json
        nanobot run
    
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ADMIN_ID=${TELEGRAM_ADMIN_ID}
    
    volumes:
      - nanobot_session_data:/root/.nanobot
    
    ports:
      - "18790:18790"

volumes:
  nanobot_session_data:
